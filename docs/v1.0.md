# Y 平面字幕相似度判定算法设计（v1.0）

## 1. 目标与边界

* **输入**

  * 两帧亮度图：(Y^{(1)}, Y^{(2)} \in [0,255]^{H \times W})（或视频标准下的 limited range ([16,235])，实现时统一归一化）。
  * 字幕区域 ROI：矩形 (\mathcal{R})（如 ((x_0,y_0,w,h))）。
  * 已知字幕亮度均值 (\mu_{sub})（指正文填充色亮度；常见白字约高亮度）。
  * 允许亮度波动 (\Delta Y)（由系统/统计得到的波动范围）。

* **输出**

  * 二分类：Same / Not-Same（是否为**同一行字幕**）。
  * 置信度：(P \in [0,1])（相似度评分）。

* **约束与假设**

  * 字幕在 ROI 内；允许细小平移（通常 (\le 2) 像素），不考虑尺度变化。
  * 常见双线字幕、描边、抗锯齿、轻微压缩噪声与轻微亮度飘移。
  * 不做 OCR，仅基于形状/结构一致性判定“是否为同一条内容”。

---

## 2. 总体思路（多指标、对齐、融合）

1. **亮度对齐**（利用 (\mu_{sub}, \Delta Y)）：消除曝光/增益差，使相同字幕在不同帧的灰度落在一致分布。
2. **字幕像素概率图（Soft Mask）**：基于亮度先验与 ROI 直方图建模，得到每像素属于“字幕填充/描边”的概率。
3. **二值化与净化**：形态学清噪、细化，得到稳定的**字幕形状掩码**。
4. **亚像素对齐**（小范围平移搜索 + 相位相关 POC）：抵消微移和采样抖动。
5. **多指标相似度计算**（互补特征）：

   * 掩码重叠：IoU / Dice（像素重叠）
   * 边界几何：对称 Chamfer/Hausdorff（轮廓距离）
   * 结构相似：SSIM（在亮度归一化后）
   * 频域峰值：相位相关峰值与 PSR
   * 文本投影：水平/垂直投影相关（stroke 占比）
6. **分数融合与决策**：归一化后线性加权（或逻辑回归）得到总分 (S)，阈值决策并输出置信度。

> 设计理念：
>
> * **亮度先验参与** → 提高“同亮度同内容”的一致性，可解释你提出的“同亮度两帧相似度应类似”的要求。
> * **结构/边界/频域/投影**互补 → 对抗描边厚薄、抗锯齿、轻微模糊与噪声。
> * **对齐后打分** → 防止微移引发的误判。

---

## 3. 详细算法

### 3.1 亮度归一化（Brightness Normalization）

将 ROI 内像素归一化到 ([0,1]):
[
\tilde{Y}(p) = \frac{\text{clip}(Y(p),Y_{min},Y_{max})-Y_{min}}{Y_{max}-Y_{min}}
]

* 若源为 limited range，常取 (Y_{min}=16, Y_{max}=235)；否则 (0,255)。

**字幕亮度对齐**（以帧 1 为参考，将帧 2 对齐）：

* 取每帧 ROI 内接近 (\mu_{sub}) 的前 (K%) 高亮像素，估计其均值 (\hat{\mu}^{(1)}, \hat{\mu}^{(2)})。
* 估计线性映射 (a,b) 使 (\tilde{Y}^{(2)'} \approx a \tilde{Y}^{(2)} + b)，满足 (a \hat{\mu}^{(2)} + b \approx \hat{\mu}^{(1)}) 且背景均值也尽量接近（双点约束，鲁棒最小二乘）。
* 约束 (a) 在 ([0.8,1.2])，(|b| \le 0.1)，避免过拟合。
* 若系统已提供帧间亮度差 (\Delta Y_{frame})，可直接设 (b=\Delta Y_{frame}) 并仅微调 (a)。

**收益**：相同字幕在两帧的填充亮度对齐，保证“同亮度 → 相似度稳定”。

---

### 3.2 字幕像素概率图（Soft Mask）

**二类/三类混合模型（可选）**

* 模型 1（两类）：字幕填充（靠近 (\mu_{sub})） vs 背景。
* 模型 2（三类）：字幕填充、描边（靠近较低亮度 (\mu_{edge})）、背景。

  * (\mu_{edge}) 可从 ROI 低分位数（如 P10）估计，不必精确。

用简单而稳健的**亮度先验 + Logistic**得到字幕概率：
[
P_{sub}(p) = \sigma!\left(\alpha \cdot \frac{\Delta Y - \big|\tilde{Y}(p)-\tilde{\mu}*{sub}\big|}{\Delta Y}\right),
]
其中 (\sigma) 为 Sigmoid，(\tilde{\mu}*{sub}=\mu_{sub}) 归一化后。
同时用梯度幅值 (G(p))（Sobel/Canny）构造**边缘概率** (P_{edge}(p))（归一化 0–1）。

**联合字幕概率**：
[
P(p) = \lambda , P_{sub}(p) + (1-\lambda),\text{norm}!\big(G(p)\big), \quad \lambda \in [0.5,0.8]
]
使得“亮度靠近 + 有边”像素优先为字幕。

---

### 3.3 二值化与净化

* 自适应阈值：(\tau = \text{Otsu}\big(P(\mathcal{R})\big)) 或固定 (\tau \in [0.4,0.6])。
* 得到初始掩码 (M = \mathbf{1}[P \ge \tau])。
* **形态学**：开运算去噪（核半径 (r=\max(1,\lfloor h/80 \rfloor))），闭运算补洞。
* **连通域筛选**：去除面积 < (A_{min}=\max(9, \lfloor hw/400 \rfloor)) 小斑点。
* **可选骨架化**：得到细化骨架 (Sk)，便于几何度量。

> 小贴士：描边字幕（白字黑边）时，若填充与边界亮度差异很大，(P_{edge}) 有助于保留轮廓一致性。

---

### 3.4 亚像素对齐（Alignment）

在小范围位移 ((\Delta x,\Delta y)\in[-d,d])（常取 (d=2\sim 4)）内，搜索最大相关：

* **快速粗对齐**：在二值掩码 (M^{(1)}, M^{(2)}) 上做**互相关最大化**。
* **精细对齐**：对归一化灰度 (\tilde{Y}^{(1)}, \tilde{Y}^{(2)'}) 做**相位仅相关（POC）**，得到峰值位置（支持亚像素插值）。
* 应用最佳 ((\Delta x^*,\Delta y^*)) 对 (M^{(2)})、边缘图等进行平移对齐。

输出：对齐后的 (\hat{M}^{(1)}, \hat{M}^{(2)}) 与 (\hat{Y}^{(1)}, \hat{Y}^{(2)})。

---

### 3.5 多指标相似度（Complementary Metrics）

**(1) 掩码重叠（区域一致性）**

* IoU（Jaccard）：(\text{IoU} = \frac{|\hat{M}^{(1)} \cap \hat{M}^{(2)}|}{|\hat{M}^{(1)} \cup \hat{M}^{(2)}|})
* Dice：(\text{Dice} = \frac{2|\cap|}{|\hat{M}^{(1)}|+|\hat{M}^{(2)}|})
* **软 IoU（边界加权）**：用距离变换权重边界接近像素，提高抗抖动性。

**(2) 边界几何（轮廓一致性）**

* 对称 Chamfer 距离：
  [
  d_{ch} = \frac{1}{|C_1|}\sum_{p\in C_1}\min_{q\in C_2}|p-q| + \frac{1}{|C_2|}\sum_{q\in C_2}\min_{p\in C_1}|q-p|
  ]
  归一化为相似度 (S_{ch}=\exp(-d_{ch}/\beta))，(\beta) 约等于字体高度的 1–2%。

**(3) 结构相似（灰度/纹理）**

* 对对齐灰度块做 **SSIM**：(S_{ssim}\in[0,1])。
* 为减弱描边厚薄差，先对 (\hat{Y}) 做轻度高斯模糊（(\sigma\approx 0.8)）再算 SSIM。

**(4) 频域峰值（相位相关稳定性）**

* 取 POC 主峰值 (peak) 与峰值旁瓣比 **PSR**（Peak-to-Sidelobe Ratio）：
  [
  PSR = \frac{peak - \mu_{sl}}{\sigma_{sl}}
  ]
  归一化为 (S_{poc} = \sigma!\big(\gamma_1 \cdot PSR + \gamma_2 \cdot peak\big))。

**(5) 文本投影（形状摘要）**

* 计算水平/垂直投影（列/行上 1 的比例或灰度和），取**皮尔逊相关系数**：
  [
  S_{proj} = \tfrac{1}{2}\big(\rho_{hor}+\rho_{ver}\big) \in [-1,1] \Rightarrow \text{线性映射到 }[0,1]
  ]
* 对字幕小位移特别鲁棒，能快速筛除不同字符串。

---

### 3.6 分数融合与阈值决策

将各相似度归一化到 ([0,1])，线性融合：
[
S = w_1 \cdot \text{IoU} + w_2 \cdot \text{Dice} + w_3 \cdot S_{ch} + w_4 \cdot S_{ssim} + w_5 \cdot S_{poc} + w_6 \cdot S_{proj},
]
其中 ( \sum w_i = 1)。

**默认权重建议（无训练数据时的启发式）**

* (w_1=0.25)（IoU），(w_2=0.15)（Dice），(w_3=0.15)（Chamfer），
* (w_4=0.15)（SSIM），(w_5=0.15)（POC），(w_6=0.15)（投影）。

**决策阈值**

* (S \ge 0.70 \Rightarrow) Same；
* (S \le 0.55 \Rightarrow) Not-Same；
* 其间可输出“不确定”，并返回所有子分数用于上层策略或时间平滑（见 §3.8）。

> 若有标注数据，建议用**逻辑回归/小型 XGBoost**对 ([\text{IoU},\text{Dice},S_{ch},S_{ssim},S_{poc},S_{proj}]) 做监督融合与阈值校准。

---

### 3.7 快速路径（实时优化）

在低时延场景，可采用“两段式”：

1. **快速筛选**（< 0.2 ms @ 小 ROI）：亮度对齐 → 掩码 → 仅算 (S_{proj}) 与 IoU。若 (\min(S_{proj},\text{IoU}) \ge 0.65) 直接判 Same / 若 (\le 0.35) 判 Not-Same。
2. **精细确认**：仅对模糊样本再算 Chamfer、SSIM、POC 并融合。

---

### 3.8 时间一致性与鲁棒性（可选）

虽然本任务是两帧比较，但在视频流中可做轻量时域平滑：

* 对近邻帧相似度做中值/指数滑动平均，减少偶发噪声跳变；
* 对“淡入/淡出”样式，增加 (\lambda) 对 (P_{edge}) 的权重以保持轮廓一致性。

---

## 4. 伪代码（工程友好）

```pseudo
function SubtitleSame(Y1, Y2, ROI, mu_sub, DeltaY):
    # 1) Crop & Normalize
    A  = normalize(crop(Y1, ROI))
    B  = normalize(crop(Y2, ROI))

    # 2) Brightness alignment of B to A
    a,b = estimate_linear_gain_bias(A, B, mu_sub)
    Bp  = clip(a*B + b, 0, 1)

    # 3) Soft mask via brightness prior + edges
    P1 = soft_prob(A,  mu_sub, DeltaY)  # logistic on |Y - mu_sub|
    P2 = soft_prob(Bp, mu_sub, DeltaY)
    G1 = edge_strength(A);  G2 = edge_strength(Bp)
    P1 = lambda*P1 + (1-lambda)*norm(G1)
    P2 = lambda*P2 + (1-lambda)*norm(G2)

    # 4) Binarize & clean
    M1 = clean(binarize(P1))
    M2 = clean(binarize(P2))

    # 5) Alignment (small shifts)
    dx,dy = coarse_shift_from_masks(M1, M2, search=±d)
    Bp2, M2 = shift(Bp, dx,dy), shift(M2, dx,dy)
    peak, psr = phase_only_correlation(A, Bp2)

    # 6) Similarity metrics
    iou  = IoU(M1, M2)
    dice = Dice(M1, M2)
    Sch  = chamfer_similarity(boundary(M1), boundary(M2))
    Ssim = SSIM(blur(A), blur(Bp2))
    Spoc = sigmoid(g1*psr + g2*peak)
    Sproj = projection_corr(M1, M2)  # average of hor/vert

    # 7) Fusion & decision
    S = 0.25*iou + 0.15*dice + 0.15*Sch + 0.15*Ssim + 0.15*Spoc + 0.15*Sproj
    if S >= 0.70: return Same, S
    if S <= 0.55: return NotSame, S
    return Uncertain, S
```

---

## 5. 参数与默认值（可直接使用）

* 搜索位移范围 (d = 2\sim4) px；
* 形态学核半径 (r = \max(1,\lfloor h/80 \rfloor))；
* 连通域最小面积 (A_{min} = \max(9,\lfloor hw/400 \rfloor))；
* Logistic 强度 (\alpha = 6 \sim 10)（越大越“硬阈值”）；
* (\lambda = 0.6)（亮度与边缘融合权重）；
* POC 归一化 (\gamma_1=0.5, \gamma_2=0.5)；
* 决策阈值：Same ≥ 0.70；Not-Same ≤ 0.55。

> 若已知 (\Delta Y) 很小（场景稳定），可提高阈值（例如 Same ≥ 0.75）以进一步降误检。

---

## 6. 复杂度与实现建议

* ROI 像素数 (N = w \times h)。
* 主要耗时：Sobel/Canny (O(N))，形态学 (O(N))，距离变换 (O(N))，相位相关 FFT (O(N\log N))。
* 实现建议：

  * 统一使用 `float32` 归一化处理，避免 8-bit 饱和。
  * 距离变换用 `EDT`（欧式距离变换）库函数。
  * FFT 用平台优化（FFTW/Neon/AVX）。
  * 对 IoU/投影等在 **位图**上计算以提速。

---

## 7. 误差来源与对策

* **淡入/淡出**：亮度偏离 (\mu_{sub})；对齐阶段提高 (a,b) 自由度并增强边缘项权重。
* **描边厚薄变化**：边界度量（Chamfer）与投影相关能保持稳定。
* **轻微模糊/压缩**：先做高斯轻模糊再 SSIM；掩码用形态学闭运算。
* **背景纹理干扰**：Soft Mask 的亮度先验 + 连通域筛选可削弱背景噪声。
* **微移**：对齐（互相关 + POC）是关键。

---

## 8. 测试计划（建议）

* 同字幕、相同亮度；同字幕、(\pm)亮度漂移；同字幕、淡入/淡出；
* 同字幕、轻微平移/压缩噪声/模糊；
* 不同字幕（相邻字符、长度变化、上下两行变化）；
* 无字幕 vs 有字幕（掩码为空 → 直接 Not-Same）。
* 指标：准确率、召回、F1；阈值用验证集校准。

---

## 9. 工程接口（I/O 约定）

```text
bool SubtitleSame(
  const uint8_t* Y1, const uint8_t* Y2, int W, int H,
  Rect ROI, float mu_sub, float deltaY,
  float* out_score, // 返回融合相似度
  SubtitleDebug* dbg // 可选：各子分数、对齐偏移、掩码统计
)
```

---

## 10. 为什么这个方案“对同亮度帧给出相近相似度”

* 使用 (\mu_{sub}, \Delta Y) 的 **亮度对齐** 与 **亮度先验**，保证同一内容在不同帧映射到相近的概率图；
* 使用对位移不敏感的 **投影相关** 与 **边界距离**，即便像素级噪声不同也得到稳定分数；
* 多指标融合降低单一度量的方差，故在同亮度情况下输出的相似度更集中、更一致。

---

### 可选扩展（若后续需要）

* 生成**稀疏签名（SOD/Hash）**：将掩码在 (M \times N) 网格汇聚成占比特征，得到 128–256 bit 哈希，Hamming 距离快速决定是否进一步精算。
* 小型学习融合：用少量标注样本训练权重与阈值，进一步提升边界案例表现。
