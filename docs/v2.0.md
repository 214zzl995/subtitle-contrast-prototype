# Y 平面字幕相似度判定算法设计（v2.0）

> 目标：在 **仅有 Y 平面**（亮度通道）的前提下，于给定字幕区域 ROI、字幕亮度先验 (\mu_{sub}) 与可容忍亮度波动 (\Delta Y) 的条件下，稳定判定两帧是否为**相同字幕内容**。v2 面向两个困难场景强化鲁棒性：
>
> 1. **(\Delta Y) 较大（≈15）**；2) **同字幕但背景差异大**。
>
> 设计重点：**文本中心化、位移容忍、峰表表征、平移不敏感的签名、去偏归一与自适应融合**。

---

## 1. 问题定义与输入输出

* **输入**

  * 两帧亮度图：(Y^{(1)}, Y^{(2)} \in [0,255]^{H\times W})（实现中归一化至 ([0,1])）。
  * 字幕区域 ROI：矩形 (\mathcal{R}=(x_0,y_0,w,h))。
  * 字幕填充亮度先验：(\mu_{sub})（白字/浅色字常为高亮）。
  * 亮度波动允许量：(\Delta Y)。
  * 小范围搜索半径：(r\in\mathbb{Z}_{\ge0})（默认 3）。

* **输出**

  * 二分类：`same` / `different` / `uncertain`。
  * 置信度：相似度分数 (S\in[0,1])。
  * 诊断信息：多项子指标与对齐偏移。

* **假设与边界**

  * 字幕完全落入 ROI；允许 (\le 2!\sim!4) px 的位移，无尺度/旋转大变化。
  * 常见描边、抗锯齿、压缩噪声、淡入/淡出等现象存在。
  * 不进行 OCR，仅判定“是否为同一条字幕内容”。

---

## 2. v2 设计理念（相较 v1 的关键增强）

1. **文本中心化**：局部对比度归一的高通图（背景抑制），软字幕概率引入对比度门控与 (\Delta Y) 自适应斜率；所有主度量均在**文本权重**下评估或以掩码约束。
2. **位移容忍 + 峰表**：在 (\pm r) 位移窗内计算加权 NCC 地图，提取 Top-K 局部峰，使用**峰值-旁瓣比（PSR）**、**Top1-Top2 间隙（Gap12）**、**峰能量集中度**、**峰中心性**等多维峰表特征，避免仅看“单峰”。
3. **平移不敏感签名**：行/列投影的 rFFT 幅度（去 DC）构成 **SPS（spectrum signature）**；另以**网格化梯度方向直方图（EOH/HOG-lite）**捕捉笔画方向分布，均对背景与平移更稳健。
4. **去偏归一与自适应融合**：对存在“负样本也非零”的相似度（如投影/频谱/结构）施加**基线抵消**；当 (\Delta Y) 或背景差大时，自动提升形状/投影/峰表权重、降低亮度敏感项的影响。

---

## 3. 算法流程（Pipeline）

### 3.1 预处理与亮度对齐

1. ROI 裁剪与归一化：(\tilde{Y}=Y/255)。
2. **亮度对齐**（线性增益-偏置）：
   [ \tilde{Y}^{(2)'} = \operatorname{clip}(a,\tilde{Y}^{(2)}+b,,0,1) ]

   * 以靠近 (\mu_{sub}) 的高亮像素估计鲁棒均值，求 (a,b)（范围稍收紧：(a\in[0.80,1.20],\ b\in[-0.15,0.15])）。

### 3.2 背景抑制与文本概率

* **背景抑制**：局部均值/方差得到 z-score，高通并压缩动态范围至 ([0,1])，得到 (Y_{hp})。
* **字幕概率（自适应）**：

  * 距离先验：(p_\mu = \sigma(\alpha,\tfrac{\Delta Y - |Y-\mu_{sub}|}{\Delta Y}))，其中 (\alpha) 随 (\Delta Y) 自适应（(\Delta Y) 越大，(\alpha) 越小）。
  * 对比度门控：(p_c = \tanh!\big(\tfrac{|Y-\text{local_mean}|}{2.5,\text{local_std}+\varepsilon}\big))。
  * 融合：(\text{soft} = w,p_\mu + (1-w),p_c)，其中 (w\in[0.2,1)) 随 (\Delta Y) 自适应（(\Delta Y) 越大，越依赖对比度）。
* **边缘强度**：在 (Y_{hp}) 上计算 Sobel 幅值并归一化。
* **概率图**：(\text{prob} = \lambda\cdot\text{soft} + (1-\lambda)\cdot\text{edge})，推荐 (\lambda\approx0.65)。
* **二值化与净化**：Otsu 阈值→开闭运算→小连通域剔除，得掩码 (M)。

### 3.3 粗对齐

* 在掩码上做互相关最大化或穷举重叠，求得整数位移 ((\Delta x,\Delta y)\in[-r,r]^2)。
* 对第二帧的 (Y, Y_{hp}, \text{soft}, M) 应用平移对齐。

### 3.4 多特征相似度

**A. 形状与布局**

* IoU、Dice、**容错 IoU**（tIoU：先膨胀 1–2 px 再求 IoU）。
* 投影相关：行/列投影归一后点积取均值。

**B. 平移不敏感签名**

* **SPS**：对行/列投影做 rFFT 幅度（去 DC），截取前 (K) 个频带并归一，取余弦相似度。
* **EOH/HOG-lite**：在文本权重下、按 (g_y\times g_x) 网格统计梯度方向直方图（0..π），归一后余弦相似度。

**C. 峰表特征（位移容忍）**

* 在 (\pm r) 窗内形成**加权 NCC 地图**（权重=文本 soft mask 与 Hann 窗），提取 Top-K 局部极大：([(d x_i,d y_i,v_i)])。
* 指标：

  * Top1 值（(v_1) 经 ([-1,1]\to[0,1]) 归一）；
  * Gap12：(\max(0, v_1 - v_2))；
  * **PSR**（主峰-旁瓣比）；
  * 能量集中度（Top-K 正值和 / 全图正值和）；
  * 峰中心性：Top1 位移到 (0,0) 的距离归一后取 (1-\text{dist})。

**D. 结构（文本域内）**

* **Masked-SSIM**：仅在文本权重内计算，弱化背景影响。

### 3.5 去偏归一（Baseline Normalization）

* 对容易在负样本上产生非零相似度的度量（投影、SPS、EOH、Masked-SSIM），用经验基线 (b) 做：(\text{norm} = \max{0, \tfrac{s-b}{1-b}})。

### 3.6 自适应融合与决策

* 动态权重：当 (\Delta Y\ge 15)（归一化约 0.06）或估计的背景均值差 (bg_gap\ge 0.08) 时，提高 **tIoU/投影/SPS/EOH** 与 **峰表** 的权重，降低亮度敏感项权重。
* 总分：( S=\sum_i w_i,s_i \in[0,1] )。
* 判定阈值：`same`：(S\ge0.70)；`different`：(S\le0.55)；其余 `uncertain`。

---

## 4. 公式与实现细节

### 4.1 背景抑制（局部 z-score）

[ z(p)=\frac{Y(p)-\mu_{\text{local}}(p)}{\sigma_{\text{local}}(p)+\varepsilon},\quad Y_{hp}(p)=\tfrac{1}{2}\big(1+\tanh\tfrac{z(p)}{2}\big) ]

### 4.2 自适应字幕概率

[ p_\mu=\sigma!\left(\alpha\frac{\Delta Y-|Y-\mu_{sub}|}{\Delta Y}\right),\quad \alpha=\operatorname{clip}!\left(\alpha_0\frac{0.06}{\Delta Y+\varepsilon},4,12\right) ]
[ \text{soft}=w,p_\mu+(1-w),\tanh!\left(\frac{|Y-\mu_{\text{local}}|}{2.5,\sigma_{\text{local}}+\varepsilon}\right),\quad w=\frac{0.8}{1+\Delta Y/0.06}+0.2 ]

### 4.3 加权 NCC 地图与峰表

* 权重：(W=\sqrt{\text{soft}_1\wedge \text{soft}_2}\cdot\text{Hann})。
* 加权 NCC：
  [ \rho=\frac{\sum W(a-\bar a)(b-\bar b)}{\sqrt{\sum W(a-\bar a)^2}\sqrt{\sum W(b-\bar b)^2}} ]
* 在 (\pm r) 位移窗内计算 (\rho(d x,d y)) 构成地图，进行 3×3 非极大值抑制提取 Top-K 峰。
* **PSR**：剔除主峰近邻后计算 ((\text{peak}-\mu_{\text{side}})/\sigma_{\text{side}})。

### 4.4 平移不敏感的频谱签名（SPS）

* 行/列投影 (\to) rFFT 幅度，去 DC，截前 (K) 频带并 L2 归一，两个签名拼接后做余弦相似度。

### 4.5 容错 IoU（tIoU）

* 对掩码先膨胀（半径 1–2 px），再求 IoU，提高对微错位/描边差的容忍度。

---

## 5. 伪代码（顶层）

```pseudo
function SubtitleSameV2(Y1, Y2, ROI, mu_sub, DeltaY, r=3):
    A = normalize(crop(Y1, ROI));  B = normalize(crop(Y2, ROI))
    B = align_brightness(A, B, mu_sub)              # a,b 收紧

    A_hp = background_suppress(A)
    B_hp = background_suppress(B)

    soft_A = subtitle_prob(A,  mu_sub, DeltaY)
    soft_B = subtitle_prob(B,  mu_sub, DeltaY)
    edge_A = edge_strength(A_hp)
    edge_B = edge_strength(B_hp)

    prob_A = lam*soft_A + (1-lam)*edge_A
    prob_B = lam*soft_B + (1-lam)*edge_B
    M_A = post_process(prob_A)
    M_B = post_process(prob_B)

    (dx,dy) = coarse_align(M_A, M_B, r)
    shift B,B_hp,soft_B,M_B by (dx,dy)

    w_text = min(soft_A, soft_B)

    # 形状/布局
    iou,dice,tiou = overlap_metrics(M_A, M_B)
    proj = projection_corr(M_A, M_B)

    # 平移不敏感签名
    sps = spectrum_signature_sim(M_A, M_B)
    eoh = eoh_grid_sim(A_hp, B_hp, w_text)

    # 峰表特征
    ncc_map, peaks, psr, conc = ncc_peak_table(A_hp, B_hp, w_text, r)
    top1, gap12, center = peaks[0].val, peaks[0].val - peaks[1].val, center_score(peaks[0])

    ssim_m = ssim_masked(A_hp, B_hp, w_text)

    metrics = baseline_normalize({iou,dice,tiou,proj,sps,eoh,top1,gap12,psr,conc,center,ssim_m})
    weights = adapt_weights(DeltaY, bg_gap)
    S = sum_i weights[i]*metrics[i]

    if S>=0.70 return ("same", S)
    if S<=0.55 return ("different", S)
    return ("uncertain", S)
```

---

## 6. 参数与默认值

* 搜索半径 (r)：3（ROI 高度 > 120 px 可设 4）。
* (\lambda)（soft 与 edge 融合）：0.65。
* Otsu 后的形态学核半径：(\max(1, \lfloor h/80 \rfloor))。
* tIoU 膨胀半径：1（较大 ROI 可取 2）。
* SPS 频带数 (K)：16（行/列各 16，共 32 维）。
* EOH 网格：8×8；方向 bins：8。
* 峰表 Top-K：5；PSR 旁瓣窗口：5×5。
* 决策阈值：`same`≥0.70，`different`≤0.55。

> 调权自适应触发：(\Delta Y/255\ge0.06) 或 (bg_gap\ge0.08)。

---

## 7. 复杂度与实现建议

* 主要耗时：

  * 局部统计/高通、Sobel、形态学：(O(N))。
  * rFFT（1D 投影）：(O(H\log H + W\log W))，代价极低。
  * NCC 地图：(O((2r+1)^2,N)) 中的常数因子小（仅权重与逐点运算）。
* 工程建议：

  * 全流程 `float32` 处理；FFT/NCC 使用向量化；
  * 先快速路径（形状+SPS+EOH）筛选，落在灰区再跑峰表与 Masked-SSIM；
  * 提供调试可视化：prob/mask、NCC 地图与峰表、SPS/EOH 相似度。

---

## 8. 测试与标定

* **数据划分**：同字幕/不同字幕 × (\Delta Y={0,8,15,20}) × 背景差异（小/大） × 平移（0/±2 px）。
* **指标**：Accuracy、Recall、F1、ROC-AUC；同时监控负样本分数分布（期望集中在 0.1–0.25）。
* **阈值校准**：在验证集上微调 `same` 上阈（0.68–0.72）与 `different` 下阈（0.55–0.58）。
* **消融实验**：去除峰表或去除 SPS/EOH，观察正负样本分布是否明显靠拢以验证其贡献。

---

## 9. 与现有接口兼容性

* **对外接口不变**：`compute_similarity(config, repository, request) -> SubtitleSimilarityResult`。
* `SubtitleSimilarityResult.metrics`：包含 `overlap_iou/overlap_dice/overlap_tiou/layout_projection/sps_similarity/eoh_similarity/ncc_* / ssim_masked` 等标准化分量。
* `SubtitleSimilarityResult.details`：包含原始值（未归一或未去偏）、`dx/dy`、`bg_gap`、`gain/bias`、`delta_norm` 等调试信息。

---

## 10. 故障排查（FAQ）

* **不同字幕分数偏高（≈0.3）**：提高投影/SPS/EOH 的 baseline（+0.02~0.04）；将 `search_radius` 增至 4 并增大 PSR 权重；检查 mask 是否过宽，必要时收紧 Otsu 后的闭运算或提高小连通域阈值。
* **相邻帧偶有 0.6**：观察 `ncc_center/psr/gap12`，若中心性差或 PSR 低，稍增半径或提升峰表权重；若背景突变，确认 `bg_gap` 触发了自适应权重。
* **淡入/淡出导致分数波动**：亮度对齐允许更大 (b) 范围并适当降低 `w`（更多依赖对比度/边缘）。

---

## 11. 可选扩展

* **紧致行框（tight bbox）**：在掩码内提取连通域的最小外接矩形，仅在矩形内计算特征并按面积加权，进一步压制背景。
* **哈希前置筛选**：对 `SPS+EOH` 做 SimHash，Hamming 距离快速否定，降低整体延迟。
* **学习融合**：用少量标注样本对各分量做 logistic/XGBoost 融合与阈值校准。

---

## 12. 变更记录

* **v2（当前）**：

  * 新增：背景抑制、高通；峰表（NCC Top-K、PSR、Gap12、集中度、中心性）；SPS/EOH；
  * 自适应：(\Delta Y) 与背景差驱动的权重切换；
  * 去偏归一：对投影/SPS/EOH/Masked-SSIM 做基线抵消；
  * 决策：维持 0.70/0.55，建议在业务数据上校准。

* **v1**：亮度对齐 + SoftMask + 形态学 + 粗对齐 + 多指标线性融合（IoU/Dice/SSIM/POC/投影）。

---

### 附：推荐默认参数表

| 参数           |                               值 | 备注               |
| ------------ | ------------------------------: | ---------------- |
| 搜索半径 r       |                               3 | ROI 高>120可取4     |
| (\lambda)    |                            0.65 | soft 与 edge 融合权重 |
| 形态学核半径       | (\max(1, \lfloor h/80 \rfloor)) | 依据 ROI 高度        |
| tIoU 膨胀半径    |                               1 | 大 ROI 可设 2       |
| SPS 频带 K     |                              16 | 行/列各 16，共 32 维   |
| EOH 网格       |                             8×8 | bins=8           |
| Top-K 峰      |                               5 | NCC 地图局部峰        |
| PSR 旁瓣窗口     |                             5×5 | 剔除主峰邻域           |
| same 阈值      |                            0.70 | 可 0.68–0.72 校准   |
| different 阈值 |                            0.55 | 可 0.55–0.58 校准   |
