# Y 平面字幕相似度判定算法设计（v12.0）

v12.0 聚焦“背景接近字幕填充色、文本稀疏”的困难场景，通过“核心掩膜 + 结构模板 + pHash + 边缘 NCC”的组合，在不依赖 OCR/检测模型的前提下判定两帧是否同一字幕。

---

## 0. 背景与目标

- **输入**：两帧 Y 平面 ROI（`Y1, Y2`）、字幕填充亮度 `Y_sub`、亮度容差 `τ`。
- **输出**：`decision ∈ {same,different}`，附带 `score/metrics/details`。
- **约束**：
  - 字幕稀疏、描边可能存在但颜色未知；
  - 背景亮度可能与 `Y_sub` 接近；
  - 不允许调用 OCR/检测模型，仅依赖亮度域结构。

---

## 1. 设计概览

| 阶段 | 目标 | 核心手段 |
|------|------|----------|
| ① 前景稳定化 | 在强背景下抽出“笔画核心”并估计笔画宽 | 顶帽增强 + 亮度先验 + 局部对比度门控 + 腐蚀/连通域筛选 |
| ② 结构模板 | 将核心转为平移/亮度不敏感的结构签名 | 骨架化、截断距离变换、归一化模板、pHash |
| ③ 多指标判定 | 组合结构与边缘证据 | pHash 汉明距离 + 核心 IoU + 边缘 NCC（描边邻域）|

三个指标互补：pHash 感知低频结构、IoU 衡量核心重合、NCC 验证实际边缘的形状一致性。

---

## 2. 前景稳定化（每帧）

> 说明：自 v12.1.patch 合并后，ROI 在进入本章节流程前已统一进行“反向着色”预处理：所有 `|Y-μ_sub|>Δy` 的像素被映射到 `255-μ_sub`，只保留颜色窗内的信息，以下步骤默认基于该预处理结果。

1. **轻量去噪**：对 ROI 做 3×3 双边/导向/中值滤波，压缩块效应同时保留笔画边缘。
2. **顶帽增强**：根据 `Y_sub` 选择白/黑顶帽（结构元半径 2–3 px 或 `≈w_est/2`），突出细结构、抑制大尺度背景。
3. **亮度似然**：`M0 = |Y - Y_sub| ≤ τ`，仅作为初筛。
4. **局部对比度门控**：在每像素 3–7 px 邻域内计算 `c = max(Y_nbhd) - min(Y_nbhd)`，对 `M0` 乘 `c` 后阈值化，弱化大面积平坦背景。
5. **形态学净化**：开运算去掉小斑点，面积阈值 `A_min = ROI_area × (5e-4 ~ 2e-3)`。
6. **核心腐蚀**：以 `r_core ≈ max(1, floor(w_est/3))`（初始先用 1）腐蚀得到高 α **核心掩膜** `C`。
7. **笔画宽估计**：对 `C` 做距离变换，取 95% 分位 `d95`，得 `w_est = 2 · d95`；若像素不足，可退化为行/列最大连通长度。

> 物理直觉：字幕渲染满足 `Y_obs = α·Y_sub + (1-α)·Y_bg`，核心处 `α→1`。顶帽 + 腐蚀正是寻找高 α 区域。

---

## 3. 结构模板构建

1. **平滑/骨架**：将 `C` 膨胀 `r = max(1, round(w_est/6))` 以平滑锯齿，然后细化得到骨架 `S`。
2. **裁剪与扩边**：取 `S` 的最小外接矩形，外扩 `≈w_est` 形成裁剪区域。
3. **距离模板**：计算骨架的截断距离变换 `T = clip(dist_to_S, 0, w_est/2)` 并归一化至 [0,1]，消除孤立噪声，对亚像素抖动更稳。
4. **归一尺寸**：将 `T` 等比缩放并居中填入固定画布（推荐 64×256 或 32×128）。
5. **结构哈希**：对模板做 DCT，取左上 8×8 低频（去 DC），用均值二值化得到 64 bit pHash。

---

## 4. 多指标相似度

对两帧分别得到 `(C1, T1, w1)`、`(C2, T2, w2)`，组合以下度量：

1. **pHash 汉明距离 `d_H`**：衡量低频结构差异。
2. **核心 IoU**：`IoU = |C1 ∩ C2| / |C1 ∪ C2|`；在 ±1～2 px 平移窗内搜索最大值以抵消 ROI 对齐误差。
3. **边缘 NCC `ρ`**：
   - 取 Sobel 幅值 `E1, E2`；
   - 在 `C1 ∪ C2` 膨胀 `≈w/2` 的邻域内计算 Pearson/NCC；
   - 允许 ±1 px 平移搜索；
   - 可在计算前对 `E` 做轻微平滑以提升抗噪性。

> 中位笔画宽 `w = median(w1,w2)` 用于确定 NCC 膨胀半径、平移窗与阈值调节。

---

## 5. 判定策略

默认门限（1080p、硬字幕）：

| 决策 | 条件 |
|------|------|
| `same-high` | `d_H ≤ 6` 且 `IoU ≥ 0.75` |
| `same-medium` | `(d_H ≤ 12 且 ρ ≥ 0.85)` 或 `IoU ≥ 0.90` |
| `same-low` | `ρ ≥ 0.93`（颜色崩溃但结构一致） |
| `different` | 未命中以上条件 |

缩放到其它分辨率时可按比例调整：`IoU_min ≈ 0.75 / s`、`d_H_max ≈ 6 · √s`，其中 `s` 为与 64 px 高度归一化的比例。

最终分数可取 `score = 0.4·(1 - d_H/64) + 0.35·IoU + 0.25·((ρ+1)/2)` 并按上述规则输出决策/置信度。

---

## 6. 实现要点

- **ROI 对齐**：在 IoU、NCC 前做 ±1～2 px 的整像素平移搜索即可，代价极低。
- **局部对比度**：`contrast = dilate(Y) - erode(Y)`，再按百分位设门限（例如 60%）。
- **核心质量监控**：记录核心面积占比、笔画宽估计等指标，方便调参。
- **骨架失败兜底**：若骨架为空，可直接对核心距变图做模板。
- **NCC 掩膜**：取 `union(C1,C2)` 膨胀环带，若几乎为空则跳过 NCC。

---

## 7. 极端场景策略

1. **背景≈字幕**：主要依赖顶帽 + 核心腐蚀，IoU/ρ 对背景差异不敏感。
2. **描边未知**：核心只看填充内部，可将核心膨胀 `≈w/4` 形成“描边带”供 NCC 使用。
3. **压缩噪声 / 轻微缩放**：模板 pHash 是低频特征，对噪声/缩放鲁棒；NCC 可配合 1 px Gaussian。
4. **颜色渐变 / 卡拉 OK**：`d_H` 可能波动，但 `ρ` 基本稳定，可提高 ρ 权重。
5. **字幕抖动**：在 IoU、NCC 前做平移搜索或在时间轴上取最大值。

---

## 8. 伪代码

```text
function SAME_SUBTITLE(Y1, Y2, Y_sub, tau):
    C1, T1, w1 = build_core_and_template(Y1, Y_sub, tau)
    C2, T2, w2 = build_core_and_template(Y2, Y_sub, tau)
    w = median(w1, w2)

    dH = hamming(phash(T1), phash(T2))
    IoU = max_shift_iou(C1, C2, shift_range=1)

    E1 = sobel_mag(Y1)
    E2 = sobel_mag(Y2)
    mask = dilate(union(C1, C2), radius=max(1, round(w/2)))
    rho = max_shift_ncc(E1, E2, mask, shift_range=1)

    if dH ≤ 6 and IoU ≥ 0.75: return same, "high"
    if (dH ≤ 12 and rho ≥ 0.85) or IoU ≥ 0.90: return same, "medium"
    if rho ≥ 0.93: return same, "low"
    return different, "—"
```

`build_core_and_template` 即 2、3 章的流程，细节包括顶帽、对比度门控、形态学净化、距离变换、骨架化与模板归一化。

---

## 9. 参数速查

| 参数 | 默认 | 说明 |
|------|------|------|
| `τ` | max(τ_given, 2/255) | 无噪声估计时的亮度容差 |
| `A_min` | ROI_area × (5e-4 ~ 2e-3) | 小连通域过滤阈值 |
| 顶帽结构元 | 2–3 px | 分辨率越高越大 |
| `r_core` | max(1, floor(w_est/3)) | 核心腐蚀半径 |
| 模板尺寸 | 64×256 | 适合 16:9 ROI，可按需调整 |
| NCC 膨胀半径 | max(1, round(w/2)) | 描边带宽度 |

---

## 10. 复杂度与实现

- 设 ROI 像素数 `N`：形态学、距离变换、Sobel 都是 O(N)，模板 DCT 在 64×256 上近似常数。
- Python/Numpy/OpenCV 方案在单个 ROI 上毫秒级；可选用多线程批量处理。

---

## 11. 与旧版本对比

- 相较 v4.x/v5.x 的 Chamfer 主路径，v12.0 放弃密集边缘搜索，转而依赖“核心”与“低频结构”，对背景/描边噪声更稳。
- 相较 v6.0（骨架图匹配 + 行轮廓哈希），v12.0 以模板 pHash + IoU + NCC 的轻量指标组合，不需要复杂图匹配或 ECC，对部署更友好。

---

## 12. 进一步增强（可选）

- **描边双模板**：同时构建“填充核心”与“描边环带”模板，双哈希交叉验证。
- **时间滤波**：若可访问相邻帧，可对核心掩膜/模板做时间中值或最小滤波，进一步压制背景噪声。
- **半监督调参**：收集 `d_H/IoU/ρ` 统计后用逻辑回归或小型 GBDT 自动校准阈值。
