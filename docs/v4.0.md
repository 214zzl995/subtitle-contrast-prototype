# Y 平面字幕相似度判定算法设计（v4.0）

v4.0 提供一条“轻量、可解释、稀疏文本友好”的字幕相似度方案：基于硬阈值的候选前景、在候选域上进行的边缘检测、稀疏边缘点采样与双向部分 Chamfer/Hausdorff 距离搜索，并辅以骨架中位笔画宽的一致性轻惩罚。该方案不依赖高通滤波、网格密度图、频域签名或多分量加权融合，易于调参与部署。

---

## 0. 目标与范围

- 目标：判断两帧在给定 ROI 内是否为相同字幕内容，输出分数与判决。
- 适用：中/稀疏文本、背景复杂或对比度变化场景；允许小幅位移（≤3–4 像素），不考虑缩放/旋转。
- 非目标：不做亮度对齐、网格 IoU/NCC、频谱签名等复合融合；避免“软概率门控”。

---

## 1. 接口与兼容性

- 对外接口保持与既有版本一致：`compute_similarity(config, repository, request) -> SubtitleSimilarityResult`。
- request 字段沿用：`frame_a/frame_b/roi/mu_sub/delta_y/search_radius/version`。
- 在 API 中以 `version = "v4.0"` 选择本算法实现。

---

## 2. 算法概览（分步说明）

1) 前景候选（硬阈值）与轻量形态学：在 `|Y-μ_sub| ≤ Δy` 的闭区间内取布尔掩码，随后用小核开/闭操作连接细笔画，避免引入高通或复杂背景抑制。

2) 候选域内边缘检测与自适应阈值：计算 Sobel 梯度幅值；阈值取候选域内 70% 分位，使得梯度判定既自适应又不依赖全局对比度归一。

3) 边缘稀疏化与距离变换：按网格步长对子采样边缘像素得到稀疏点集（≤800 点），同时对每帧边缘图求欧氏距离变换（到最近边缘像素的距离，单位像素）。

4) 双向“部分 Chamfer/Hausdorff”搜索：在 `±r` 窗内枚举整像素位移，分别计算 A→B 与 B→A 的截尾均值距离（保留较小 80% 的距离、并对大距离裁剪到 4px），并统计“紧密匹配”（≤1.5px）的点占比。双向平均得到总代价与匹配率，取最优位移。

5) 归一化相似度与风格轻惩罚：将最优代价按 ROI 对角线 `σ=0.03·diag` 归一为核心相似度 `exp(-(C/σ)^2)`；利用骨架处中位笔画宽差 `|w_medA - w_medB|` 乘以 `exp(-(Δw/2)^2)` 形式的轻惩罚，抑制“轮廓像但风格不同”。

6) 判决：默认阈值 `τ_sim=0.60` 与 `τ_match=0.55`；两者均满足判作 same，否则 different（可在你的数据上微调 0.02–0.05）。

---

## 3. 关键模块与细节

- 前景候选：`M = |Y-μ_sub|≤Δy`。建议 Δy 来源于业务侧或交互输入；当 Δy 较大时，算法仍主要依赖边缘几何而非亮度细节。
- 形态学开/闭：小核（如开 1×1、闭 2×1）足以连通细笔画，避免过度平滑。
- Sobel 边缘阈值：在 `M==1` 区域内取 70% 分位；若候选过少，可回落到全图分位。
- 稀疏点采样：网格步长 2，最多 800 点；过密会增加搜索成本且收益有限。
- 距离变换（DT）：欧氏距离，单位像素；当边缘为空时返回 `+∞`，避免错误参与。
- 部分 Chamfer：对每个位移，单向代价为“截尾均值（保留 80% 最小距离）”，并记录“≤1.5px 的命中率”。双向平均具备鲁棒性。
- 笔画宽度：对 `~M` 做 DT，骨架像素处的 `2*DT` 近似笔画宽；取中位数以抑制异常。

---

## 4. 默认参数（建议）

- `grid_step = 2`；`max_points = 800`
- `keep_quantile = 0.80`；`clip_px = 4.0`；`tight_px = 1.5`
- `sigma = 0.03 * diag(roi)`；`τ_sim = 0.60`；`τ_match = 0.55`

提示：若 ROI 显著变大，可适度增大 `max_points`；若噪点较多，可将 `keep_quantile` 降至 0.70。

---

## 5. 复杂度与性能

- DT 复杂度约 `O(W·H)`；搜索复杂度约 `O(|P|·(2r+1)^2)`。
- 典型 640×180、`r=3`、`|P|≈300–800`，总采样 1–4 万次，CPU 毫秒级可完成。
- 可选加速：
  - 用 `uint8/uint16` DT 与简易 LUT 代替浮点裁剪；
  - 在进入 Chamfer 前做行级 bitset 预重叠计数以快速拒绝；
  - 连续帧时对 `best_shift` 做 ±1 约束或指数平滑以抗抖。

---

## 6. 局限与注意事项

- 不处理缩放/旋转；当字体大小变化明显时相似度会下降。
- 过小 ROI 或极少笔画时，匹配率统计可能不稳定；可降低 `τ_match` 至 0.50 观察。
- Δy 设置过宽会引入背景噪声，过窄会漏检笔画；建议结合数据经验微调。

---

## 7. 与 v3.0 的关系

- v3.0 通过“行带 + 网格密度 + 峰表 + 自适应融合”在密文本场景表现更强；
- v4.0 通过“稀疏点 + 双向部分 Chamfer + 宽度轻惩罚”在稀疏/细笔画场景更稳；
- 两者可互补：业务可按场景选择版本或在前端提供可选项（本仓库 API/前端已提供）。

---

## 8. 实现对照（similarity_v40.py）

- 前景与形态学：`_morph_open/_morph_close`
- 边缘与阈值：`_sobel_gradient`、`_adaptive_percentile`
- 稀疏采样：`_sample_edge_points`
- 距离变换：`_distance_transform`（内部 `_edt_1d`）
- 单向部分 Chamfer：`_one_way_partial_chamfer`
- 双向搜索：`_search_best_shift`
- 笔画宽估计：`_skeletonize`、`_median_stroke_width`
- 入口：`compute_similarity`（产生 `SubtitleSimilarityResult`）

---

## 9. 指标与调试输出

- similarity：最终分数（0–1），`= core_similarity × stroke_width_penalty`
- core_similarity：由 `exp(-(best_cost/σ)^2)` 得到，反映几何匹配程度
- match_fraction：紧密匹配（≤1.5px）的双向平均占比
- stroke_width_penalty：宽度一致性轻惩罚项 `exp(-(Δw/2)^2)`
- best_shift：最佳整像素位移 (dx, dy)
- best_cost_px：部分 Chamfer 截尾均值代价（像素）

---

## 10. 测试建议

- 覆盖：稀疏/中等/密文本 × 位移（0/±2/±4）× Δy（窄/中/宽）× 背景复杂度（低/高）。
- 观察：正样本 similarity 与 match_fraction 的均值/方差；负样本分布应集中在低位（≤0.3）。
- 敏感性：调整 `keep_quantile/clip_px/tight_px` 及 `τ_sim/τ_match`，记录 ROC/PR 变化。

---

## 附：伪代码（参考实现）

```pseudo
function SUBTITLE_SAME(Y1, Y2, roi, mu_sub, delta_y, r):
    I1 = crop(Y1, roi);  I2 = crop(Y2, roi)
    M1 = |I1 - mu_sub| <= delta_y;  M2 = |I2 - mu_sub| <= delta_y
    M1 = close(open(M1, 1x1), 2x1); M2 = close(open(M2, 1x1), 2x1)
    G1 = sobel(I1); G2 = sobel(I2)
    t1 = percentile(G1 where M1==1, 70%); t2 = percentile(G2 where M2==1, 70%)
    E1 = (G1 >= t1) AND M1; E2 = (G2 >= t2) AND M2

    P1 = sample_edges(E1, max_points=800, step=2)
    P2 = sample_edges(E2, max_points=800, step=2)
    DT1 = distance_transform(E1); DT2 = distance_transform(E2)

    S1 = skeletonize(M1); S2 = skeletonize(M2)
    Wmap1 = distance_transform(NOT M1); Wmap2 = distance_transform(NOT M2)
    w_med1 = median(Wmap1 on S1) * 2; w_med2 = median(Wmap2 on S2) * 2

    best = argmin over (dx,dy) in [-r,+r]^2 of 0.5*(C(P1→DT2,dx,dy)+C(P2→DT1,-dx,-dy))
    where C = truncated_mean_of_small80pct(distances),
          and match_fraction = mean(dist <= 1.5px) averaged bi-directionally.

    σ = 0.03 * diag(roi)
    sim_core = exp(-(best.cost/σ)^2)
    sim = sim_core * exp(-(abs(w_med1-w_med2)/2)^2)
    same = (sim >= 0.60) AND (best.match_fraction >= 0.55)
    return same, {sim, best_shift, best_cost_px, matched_fraction, stroke_w_med}
```

---

### 一句话总结

v4.0 用“硬阈值候选 + 候选域边缘 + 稀疏点 + 双向部分 Chamfer + 宽度轻惩罚”解决稀疏字幕的稳健匹配问题，参数少、可解释、易部署，同时与 v3.0 在密文本场景形成互补。
