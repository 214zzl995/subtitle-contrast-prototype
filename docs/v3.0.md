# Y 平面字幕相似度判定算法设计（v3.0）

## 0. 目标与改进点概览

* **目标**：两帧是否为**同一字幕内容**，输出分数 (S\in[0,1]) 与决策（same/different/uncertain）。
* **v3 关键改进**

  1. **行带锚点（Band Anchoring）**：用水平投影稳定定位 1–2 个“字幕行带”，后续全部特征**只在行带**域内计算，强抑背景。
  2. **网格前景密度图（GFRM）**：将“接近 (\mu_{sub})”的前景像素在行带内投射到**粗网格密度图**，再做**小位移相关**与 IoU（对密文本极稳）。
  3. **峰表相关（Peak Table Matching）**：在 (\pm r) 位移窗内对密度图/NCC 图做**Top‑K 局部峰**特征（峰值、PSR、Top1‑Top2 间隙、峰中心性、能量集中度），避免“单峰过敏”。
  4. **稀疏组分匹配（Sparse Components Matching）**：当前景稀疏时，以**连通域中心/宽度/间距**作为**字符锚点序列**，做 1D 对齐 + 动态时间规整（DTW‑lite）/匈牙利分配相似度。
  5. **平移不敏感签名**：行/列投影**频谱幅度签名（SPS）**与**网格 EOH（HOG‑lite）**，捕捉文本“节律/笔画方向”而不吃背景。
  6. **亮度似然 LLR 与去偏归一**：所有与亮度/投影有关的相似度都做**基线抵消**，把不同字幕的“随机相似”压到 0.1–0.2 区间。
  7. **密度自适应融合**：根据“前景占比 (\rho)”与“离散度/熵”自动切换**密文本分支**与**稀疏文本分支**的权重。

> 预期效果：
>
> * **密文本**：v3 对**网格密度结构 + 峰表**极敏感，正样本通常 (S\ge 0.8)；
> * **稀疏文本**：稀疏组分匹配 + 行带锚点显著拉高正样本分数（避免你遇到的 0.35 天花板），负样本分数保持低位。

---

## 1. 输入/输出与假设

* **输入**：两帧 Y（归一化到 ([0,1])），ROI，(\mu_{sub}\in[0,1])，(\Delta Y\in[0,1])，搜索半径 (r)。
* **输出**：`decision ∈ {same,different,uncertain}`，`score ∈ [0,1]`，并返回各子指标与对齐偏移。
* **假设**：字幕位于 ROI，横向排布近似均匀；允许 (\le 2\sim4)px 位移，无明显缩放旋转。

---

## 2. 预处理（亮度对齐 + 前景似然）

1. **亮度对齐**
   [
   Y_2'=\operatorname{clip}(a Y_2+b,0,1),\quad
   a\in[0.80,1.20],\ b\in[-0.15,0.15]
   ]
   用接近 (\mu_{sub}) 的高亮像素估计鲁棒均值（与 v2 类似，但范围收紧）。

2. **前景似然（LLR）**

* 令前景阈带：(|Y-\mu_{sub}|\le\Delta Y_f)，其中 (\Delta Y_f = \min(\Delta Y, 0.08))。
* **像素级对数似然比**（稳定而简单）：
  [
  \ell(p)=\log\frac{P(Y(p)\mid \text{FG})}{P(Y(p)\mid \text{BG})}
  ]
  其中 (P(\cdot\mid \text{FG})\propto \mathbf{1}(|Y-\mu_{sub}| \le \Delta Y_f))（或小方差高斯核），
  (P(\cdot\mid \text{BG})) 用 ROI 亮度直方图估计（去掉前 1–2% 高亮尖峰）。
  得到软前景图 (F=\sigma(\kappa\cdot \ell))，(\kappa \in [2,4])。

> 与 v2 不同：这里**直接使用 (\mu_{sub}) 带状先验 + 背景直方图**，对“同亮度、均匀分散”的字幕非常对口，避免把“高对比的背景纹理”当成文本。

3. **行带锚点（Band Anchoring）**

* 在 (F) 上做**水平投影** (H(y)=\sum_x F(x,y))，用平滑后找 1–2 个主峰（行中心）。
* 对每个主峰，建**行带**：高度 (h_b = c_b \cdot \hat{s})，(\hat{s}) 为估计笔画高（可用峰宽/梯度统计），(c_b=2.0\sim2.5)。
* 将后续所有特征**限制在行带并集** (\mathcal{B}) 内（极大抑制背景）。

---

## 3. 两条分支的核心特征

### 3.1 密文本分支（Dense Branch）

**(A) 网格前景密度图（GFRM）**

* 将 (\mathcal{B}) 划分为 (G_x\times G_y) 网格（建议 (G_x=24,G_y=\text{每行}2)）。
* 计算每格**前景占比** (R_{ij}=\frac{1}{|C_{ij}|}\sum_{p\in C_{ij}} \mathbf{1}(|Y(p)-\mu_{sub}|\le \Delta Y_f))，或用 (F) 求平均。
* 对 (R) 做**轻平滑**（高斯 (\sigma=0.5) 单元）得到 (R^\ast)。

**(B) 小位移相关 + GIoU**

* 在 (\pm r) 单元内，对 (R^\ast) 做**归一化互相关（NCC）**，得峰表（Top‑K 值/位置/PSR/集中度/中心性）。
* 对阈值化的高密格（二值 (B=\mathbf{1}[R^\ast\ge \tau_R])）做**格级 IoU**与**容错 IoU（邻近膨胀 1 单元）**。

> 直觉：密文本时，**格子里的占比曲线**是对“均匀分散”假设的离散化刻画；同一字幕在格子层面会形成**稳定的条纹/节律**，与背景解耦。

**(C) 行带投影频谱（SPS‑band）**

* 在 (\mathcal{B}) 内对行/列投影取 rFFT 幅度（去 DC），取前 (K=16) 频带，做余弦相似度。

### 3.2 稀疏文本分支（Sparse Branch）

**(A) 组分锚点序列（Components Anchors）**

* 在 (\mathcal{B}) 内对二值前景做连通域提取，保留面积/细长比符合“字符”先验的组分。
* 记每个组分的 ((x_c, w))：中心 (x_c) 与宽度 (w)，并按 (x_c) 排序，得到锚点序列 (\mathcal{A}={(x_c^k, w^k)})。
* **间距序列**：(\Delta^k = x_c^{k+1}-x_c^k)；**宽度序列**：(\omega^k=w^k)。

**(B) 1D 对齐与匹配**

* **DTW‑lite**：在允许 (\pm)10% 时轴伸缩下，对 (\Delta) 与 (\omega) 两个序列做加权 DTW 距离，映射为相似度。
* 或用**匈牙利分配**在代价矩阵 (C_{ij}=\alpha|x_c^i-x_c'^j|+\beta|w^i-w'^j|) 下求最小匹配代价。

**(C) 列投影稀疏签名（Sparse Column Signature）**

* 在 (\mathcal{B}) 内按列统计前景比例 (P(x))，做**零均值互相关（ZNCC）**与**符号阈值哈希（FRCS bitstring）**的汉明相似度（前者细腻，后者快且对强噪声稳）。

---

## 4. 统一度量与去偏

统一把各相似度映射到 ([0,1])，并对“负样本也常有非零底”的度量做**基线抵消**：
[
\text{norm}(s; b)=\max!\left(0, \frac{s-b}{1-b}\right),
]
建议基线：

* (b_{SPS}=0.08)，(b_{proj}=0.10)，(b_{EOH}=0.10)，(b_{\text{ZNCC-列}}=0.08)。

**密文本分支分量**（示例）：

* (S_{\text{GIoU}})、(S_{\text{tGIoU}})、(S_{\text{NCC-格}})、(S_{\text{PSR}})、(S_{\text{Gap12}})、(S_{\text{Center}})、(S_{\text{SPS}})。

**稀疏文本分支分量**（示例）：

* (S_{\text{Anchors}})（DTW‑lite/匈牙利映射到 [0,1]）、(S_{\text{ZNCC-列}})、(S_{\text{FRCS}})、(S_{\text{SPS}})。

---

## 5. 密度自适应融合

定义前景占比 (\rho=\frac{|{p\in\mathcal{B}: |Y-\mu_{sub}|\le \Delta Y_f}|}{|\mathcal{B}|})；
定义离散度（网格熵）(H=-\sum \pi_{ij}\log\pi_{ij}/\log(G_x G_y))，(\pi_{ij}=\frac{R_{ij}}{\sum R_{ij}})。

* **密文本条件**：(\rho\ge 0.10) 且 (H\ge 0.55)（横向均匀分散）
  → 加权（示例，归一后）：
  [
  \begin{aligned}
  &w_{\text{GIoU}}=0.20,\ w_{\text{tGIoU}}=0.18,\ w_{\text{NCC-格}}=0.15,\
  &w_{\text{PSR}}=0.08,\ w_{\text{Gap12}}=0.06,\ w_{\text{Center}}=0.05,\ w_{\text{SPS}}=0.28
  \end{aligned}
  ]
* **稀疏文本条件**：(\rho<0.10) 或 (H<0.55)
  [
  w_{\text{Anchors}}=0.40,\ w_{\text{ZNCC-列}}=0.22,\ w_{\text{FRCS}}=0.18,\ w_{\text{SPS}}=0.20
  ]

总分：(S=\sum_i w_i \cdot \text{norm}_i )。
阈值维持：`same` (\ge 0.70)；`different` (\le 0.55)（可在你的验证集上微调 0.02–0.03）。

---

## 6. 端到端伪代码

```pseudo
function SubtitleSameV3(Y1, Y2, ROI, mu_sub, DeltaY, r=3):
    # 裁剪与归一
    A = normalize(crop(Y1, ROI));  B = normalize(crop(Y2, ROI))
    # 亮度对齐
    B = align_brightness(A, B, mu_sub)  # a∈[0.80,1.20], b∈[-0.15,0.15]

    # 前景似然（基于 μ_sub 带状 + BG 直方图）
    FA = foreground_likelihood(A, mu_sub, DeltaY)
    FB = foreground_likelihood(B, mu_sub, DeltaY)

    # 行带锚点（1~2 条）
    bands = find_text_bands(FA)   # peaks of horizontal projection
    A_band, B_band = mask_to_bands(A, bands), mask_to_bands(B, bands)
    FA, FB = mask_to_bands(FA, bands), mask_to_bands(FB, bands)

    # 网格密度与粗对齐（在行带内）
    R_A = grid_ratio_map(FA, Gx=24, Gy=2*#bands)     # 每格前景占比
    R_B = grid_ratio_map(FB, Gx=24, Gy=2*#bands)

    (dx, dy) = coarse_align_grid(R_A, R_B, r)        # 单元级 NCC 最大
    R_Bs = shift_grid(R_B, dx, dy); FBs = shift_image(FB, dx, dy)

    # 估计密度与熵决定分支
    rho, H = density_ratio(FB), grid_entropy(R_Bs)
    if rho >= 0.10 and H >= 0.55:
        # --------- 密文本分支 ---------
        S_giou  = grid_iou(R_A, R_Bs, thr=τR)
        S_tgiou = grid_tolerant_iou(R_A, R_Bs, thr=τR, expand=1)
        peak_tbl = peak_table(R_A, R_Bs, r)          # NCC-格 TopK, PSR, gap, center, concentration
        S_sps   = band_spectrum_sim(FA, FBs, K=16)
        sims = compose_dense(S_giou, S_tgiou, peak_tbl, S_sps)
        S = fuse_dense(sims, DeltaY, rho, H)         # 自适应权重
    else:
        # --------- 稀疏文本分支 ---------
        A_comp = components_in_bands(FA)             # 连通域过滤后得到 (xc, w)
        B_comp = components_in_bands(FBs)
        S_anchor = anchors_match(A_comp, B_comp)     # DTW-lite 或 匈牙利
        S_zncc  = zncc_column_profile(FA, FBs)
        S_frcs  = frcs_hamming(FA, FBs)
        S_sps   = band_spectrum_sim(FA, FBs, K=16)
        sims = compose_sparse(S_anchor, S_zncc, S_frcs, S_sps)
        S = fuse_sparse(sims, DeltaY, rho, H)

    decision = (S >= 0.70 ? "same" : (S <= 0.55 ? "different" : "uncertain"))
    return decision, S, details(sims, dx, dy, rho, H)
```

---

## 7. 关键实现细节

### 7.1 行带锚点（稳住“属于字幕的区域”）

* 水平投影 (H(y)) 先做 1D 高斯滤波（(\sigma=2) 像素），取主峰；
* 峰宽 (\Rightarrow) 估计笔画高 (\hat{s})（半高全宽/导数过零间距）；
* 行带高 (h_b=2.0\sim2.5\cdot \hat{s})，**上下对称扩大**以包住描边与抗锯齿；
* 若两峰间距 < (2.2 h_b) 则合并为双行带（Gy=4）。

### 7.2 网格参数

* (G_x=24) 能细分横向节律（小于字符宽度的一半），(G_y=2) 每行两层可表达描边/上/下缘差异；
* 阈值 (\tau_R)：行带内 (R) 的 Otsu 或固定 0.25–0.35；
* **粗对齐**先在网格上做 NCC，再在像素域微调（可选，相位相关限定在行带）。

### 7.3 稀疏组分过滤

* 组分面积阈值：(\ge \max(9,,\text{ROI面积}/600))；
* 细长比：(0.2 \le \frac{\text{宽}}{\text{高}} \le 6)；
* 与行带边界距离 (\ge 1) 像素；
* 过密簇用 DBSCAN‑lite 合并（防止将描边内孔当成独立字符）。

### 7.4 FRCS（阈值哈希）

* 列占比 (P(x)) 用 (\theta)（如 0.20）二值化为 bit 序列；
* 以 4 或 8 为窗口作**多数表决降采样**到 128–256 bit；
* 相似度 = (1-\frac{\text{Hamming距离}}{L})，用于快速拉开负样本。

### 7.5 去偏与阈值校准

* 为避免“不同字幕 ≈ 0.3”的底噪：对 (S_{SPS})、(S_{\text{投影}})、(S_{\text{EOH}})、(S_{\text{ZNCC‑列}}) 做基线抵消；
* 你的数据若背景花，建议把这些基线各自**再加 0.02–0.04**；
* 稀疏情况下可把 `same` 阈值适度降到 **0.68**。

---

## 8. 为什么 v3 能解决你的两张图

* **图 1（密文本）**：GFRM 将“均匀分散的同亮度点”聚合为**格子密度节律**；行带约束 + 网格 NCC/IoU 几乎只看文本，背景大差异也不影响；PSR/Gap12/中心性把“真峰”（居中、尖锐）与“背景假峰”分离。
* **图 2（稀疏文本）**：v2 的投影/边缘不够敏感；v3 的“组分锚点序列 + 列 ZNCC + FRCS”直接匹配**字符中心与间距模式**，即使字符少也能形成稳定相似度，显著拉高同字幕得分。

---

## 9. 参数建议（默认）

| 模块   | 参数           |                         默认 | 说明        |
| ---- | ------------ | -------------------------: | --------- |
| 亮度对齐 | (a,b) 限制     | [0.80,1.20] / [-0.15,0.15] | 降过拟合      |
| 前景阈带 | (\Delta Y_f) |      (\min(\Delta Y,0.08)) | 抑背景       |
| 行带   | (c_b)        |                        2.2 | 行带高度系数    |
| 网格   | (G_x,G_y)    |                   24, 2×行数 | 密度分解能     |
| 网格阈  | (\tau_R)     |                        0.3 | 或 Otsu    |
| 峰表   | Top‑K        |                          5 | PSR 窗 5×5 |
| 稀疏匹配 | 伸缩           |                       ±10% | DTW‑lite  |
| FRCS | 长度           |                128–256 bit | 多数降采样     |
| 决策阈值 | same/diff    |                0.70 / 0.55 | 可微调       |

---

## 10. 与现有代码的对应关系（实现指引）

不改变 `compute_similarity(...)` 的**外部接口**，内部建议这样落地（均可用 `numpy` 实现）：

1. **替换/新增**

   * `foreground_likelihood(...)`（基于 (\mu_{sub})+BG 直方图的 LLR）；
   * `find_text_bands(FA)`（水平投影+峰宽估计）；
   * `grid_ratio_map(F, Gx, Gy)` 与 `coarse_align_grid(RA, RB, r)`；
   * `peak_table(RA, RB, r)`（NCC‑格地图 Top‑K、PSR、Gap12、Center、Concentration）；
   * 稀疏分支：`components_in_bands(F) -> [(xc,w)]`、`anchors_match(...)`（DTW‑lite 或匈牙利）、`zncc_column_profile(...)`、`frcs_hamming(...)`。

2. **融合**

   * 计算 (\rho,H) → 走**密**或**稀疏**分支；
   * 各分量做**baseline normalize** → 动态权重加权 → 总分 → 阈值决策。

3. **调试输出**（写入 `details/metrics`）

   * 行带位置与高度、(\rho,H)、网格 IoU/tIoU、峰表（Top‑K 值/位移/PSR）、稀疏锚点匹配代价、FRCS/Hamming、SPS 相似度等。

---

## 11. 测试计划（建议）

* **分布覆盖**：密/中/稀疏 × (\Delta Y={0,8,15,20}) × 背景差（小/大） × 位移（0/±2px）。
* **评估**：正样本分数均值/方差、负样本分布（目标：负样本集中 0.10–0.25；密文本正样本 (≥0.80)，稀疏文本 (≥0.70)）。
* **消融**：去掉 GFRM/峰表/稀疏锚点/SPS 逐一测试贡献；
* **阈值校准**：若负样本尾部>0.3，可稍增各基线或把 `different` 阈值提到 0.58。

---

### 一句话总结

v3 把“同亮度的、横向**均匀分散**的字幕点集”转成**行带 + 网格密度 + 峰表**（对密文本极强），再用**锚点序列/列相关/FRCS**专门解决**稀疏文本**。这两条分支由前景占比与网格熵自适应切换，配合去偏归一，能显著降低“不同字幕的 0.3 底噪”，并把“同字幕”稳定拉到你期望的高分区间。


